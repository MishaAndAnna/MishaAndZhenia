<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тетрис для Миши и Анны</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        :root {
            --primary-color: #2563eb;
            --primary-light: #60a5fa;
            --primary-dark: #1e40af;
            --secondary-color: #10b981;
            --secondary-light: #34d399;
            --secondary-dark: #059669;
            --accent-color: #f59e0b;
            --accent-dark: #d97706;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --background-color: #f3f4f6;
            --board-bg: #e0f2fe;
            --board-border: #3b82f6;
            --white: #ffffff;
            --black: #111827;
            --gray-100: #f9fafb;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --border-radius: 16px;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            background: linear-gradient(135deg, #e0f2fe 0%, #f3f4f6 100%);
            color: var(--gray-700);
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .app-header {
            background: linear-gradient(to right, var(--primary-color), var(--primary-light));
            color: var(--white);
            padding: 24px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .app-header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: 1.5px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
            overflow-y: auto;
            height: calc(100vh - 96px);
        }
        
        .card {
            background: linear-gradient(145deg, var(--white), #f1f5f9);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            padding: 32px;
            margin-bottom: 32px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
        }
        
        .player-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .player-input {
            padding: 12px 16px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            background: var(--gray-100);
        }
        
        .player-input:focus {
            border-color: var(--primary-light);
            outline: none;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
            background: var(--white);
        }
        
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            background: linear-gradient(to right, var(--primary-color), var(--primary-light));
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 160px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .button:hover {
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        
        .button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .button:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .button i {
            margin-right: 8px;
        }
        
        .button-success {
            background: linear-gradient(to right, var(--secondary-color), var(--secondary-light));
        }
        
        .button-success:hover {
            background: linear-gradient(to right, var(--secondary-dark), var(--secondary-color));
        }
        
        .message {
            text-align: center;
            margin-bottom: 32px;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--white);
            border-radius: 8px;
            background: var(--gray-500);
            opacity: 0;
            transition: opacity 0.3s ease;
            min-height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .message.visible {
            opacity: 1;
        }
        
        .message.info {
            background: var(--primary-light);
        }
        
        .message.success {
            background: var(--secondary-color);
        }
        
        .message.error {
            background: var(--danger-color);
        }
        
        .game-container {
            display: flex;
            justify-content: center;
            gap: 48px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }
        
        .board-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--gray-100);
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .board-title {
            margin-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
        }
        
        .board-title i {
            margin-right: 12px;
            color: var(--secondary-color);
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(10, 32px);
            grid-template-rows: repeat(20, 32px);
            gap: 2px;
            background: var(--board-bg);
            padding: 4px;
            border-radius: 8px;
            border: 3px solid var(--board-border);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .preview-board {
            display: grid;
            grid-template-columns: repeat(4, 32px);
            grid-template-rows: repeat(4, 32px);
            gap: 2px;
            background: var(--board-bg);
            padding: 4px;
            border-radius: 8px;
            border: 3px solid var(--board-border);
            margin-bottom: 24px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .cell {
            width: 32px;
            height: 32px;
            background: #bfdbfe;
            border-radius: 4px;
            position: relative;
            transition: background 0.2s ease;
        }
        
        .cell.filled {
            background: var(--primary-dark);
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .cell.filled:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.3) 0%, 
                rgba(255, 255, 255, 0.1) 25%, 
                rgba(255, 255, 255, 0) 50%, 
                rgba(0, 0, 0, 0.1) 75%, 
                rgba(0, 0, 0, 0.3) 100%);
        }
        
        .cell.moving {
            background: var(--secondary-color);
            animation: pulse 0.5s infinite alternate;
        }
        
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }
        
        .game-info {
            text-align: center;
            margin-bottom: 32px;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-dark);
            background: var(--gray-100);
            padding: 12px;
            border-radius: 8px;
        }
        
        .game-stats {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            background: var(--gray-100);
            padding: 12px;
            border-radius: 8px;
        }
        
        .stat {
            font-size: 1.1rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
        }
        
        .rules {
            padding: 32px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            margin-top: 32px;
            border-left: 4px solid var(--primary-light);
        }
        
        .rules h2 {
            color: var(--primary-dark);
            font-size: 2rem;
            margin-top: 0;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 8px;
        }
        
        .rules h2 i {
            margin-right: 12px;
            color: var(--secondary-color);
        }
        
        .rules p {
            margin-bottom: 16px;
            line-height: 1.7;
            color: var(--gray-600);
        }
        
        .rules ul {
            padding-left: 24px;
            margin-bottom: 24px;
        }
        
        .rules li {
            margin-bottom: 12px;
            line-height: 1.7;
            color: var(--gray-600);
            position: relative;
            padding-left: 12px;
        }
        
        .rules li:before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--primary-light);
            font-size: 1.2rem;
        }
        
        @media (max-width: 768px) {
            .app-header h1 {
                font-size: 2.2rem;
            }
            
            .game-container {
                flex-direction: column;
                gap: 32px;
            }
            
            .game-board, .preview-board {
                grid-template-columns: repeat(10, 28px);
                grid-template-rows: repeat(20, 28px);
            }
            
            .preview-board {
                grid-template-columns: repeat(4, 28px);
                grid-template-rows: repeat(4, 28px);
            }
            
            .cell {
                width: 28px;
                height: 28px;
            }
            
            .button {
                padding: 10px 20px;
                font-size: 0.95rem;
            }
        }
        
        @media (max-width: 480px) {
            .app-header h1 {
                font-size: 1.8rem;
            }
            
            .game-board, .preview-board {
                grid-template-columns: repeat(10, 24px);
                grid-template-rows: repeat(20, 24px);
            }
            
            .preview-board {
                grid-template-columns: repeat(4, 24px);
                grid-template-rows: repeat(4, 24px);
            }
            
            .cell {
                width: 24px;
                height: 24px;
            }
            
            .card {
                padding: 20px;
            }
            
            .player-input {
                padding: 10px;
                font-size: 0.9rem;
                min-width: 160px;
            }
            
            .button {
                padding: 8px 16px;
                font-size: 0.9rem;
                min-width: 140px;
            }
            
            .rules h2 {
                font-size: 1.6rem;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <h1><i class="fas fa-cube"></i> Тетрис для Миши и Анны</h1>
    </header>
    
    <div class="container">
        <div class="card">
            <div class="player-info">
                <input type="text" id="playerName" class="player-input" placeholder="Ваше имя">
                <input type="text" id="gameId" class="player-input" placeholder="ID игры">
                <button id="connectGame" class="button"><i class="fas fa-link"></i> Подключиться к игре</button>
                <button id="startGame" class="button" disabled><i class="fas fa-play"></i> Начать игру</button>
            </div>
            
            <div class="message" id="message"></div>
            
            <div class="game-info" id="gameInfo"><i class="fas fa-info-circle"></i> Подключитесь к игре...</div>
            
            <div class="game-container">
                <div class="board-container">
                    <div class="board-title" id="player1Title"><i class="fas fa-gamepad"></i> Ваше поле</div>
                    <div class="game-board" id="gameBoard1"></div>
                    <div class="board-title"><i class="fas fa-eye"></i> Следующая фигура</div>
                    <div class="preview-board" id="previewBoard1"></div>
                    <div class="game-stats">
                        <div class="stat">Счет: <span id="score1">0</span></div>
                        <div class="stat">Уровень: <span id="level1">1</span></div>
                        <div class="stat">Линии: <span id="lines1">0</span></div>
                    </div>
                </div>
                <div class="board-container">
                    <div class="board-title" id="player2Title"><i class="fas fa-gamepad"></i> Поле Аннюты</div>
                    <div class="game-board" id="gameBoard2"></div>
                    <div class="board-title"><i class="fas fa-eye"></i> Следующая фигура</div>
                    <div class="preview-board" id="previewBoard2"></div>
                    <div class="game-stats">
                        <div class="stat">Счет: <span id="score2">0</span></div>
                        <div class="stat">Уровень: <span id="level2">1</span></div>
                        <div class="stat">Линии: <span id="lines2">0</span></div>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <div class="button-group">
                    <button id="pauseButton" class="button button-success" disabled>
                        <i class="fas fa-pause"></i> Пауза
                    </button>
                    <button id="restartButton" class="button button-danger" disabled>
                        <i class="fas fa-redo"></i> Начать заново
                    </button>
                </div>
            </div>
        </div>
        
        <div class="rules">
            <h2><i class="fas fa-book"></i> Правила игры</h2>
            <p><strong>1. Цель игры:</strong> Укладывайте падающие фигуры (тетромино) так, чтобы заполнить горизонтальные линии на игровом поле.</p>
            <p><strong>2. Управление:</strong></p>
            <ul>
                <li><strong>Ваше управление:</strong></li>
                <li>← : Двигать фигуру влево</li>
                <li>→ : Двигать фигуру вправо</li>
                <li>↓ : Ускорить падение фигуры</li>
                <li>↑ : Повернуть фигуру</li>
                <li>Пробел : Бросить фигуру вниз</li>
                <li><strong>Управление Аннюты:</strong></li>
                <li>A : Двигать фигуру влево</li>
                <li>D : Двигать фигуру вправо</li>
                <li>S : Ускорить падение фигуры</li>
                <li>W : Повернуть фигуру</li>
                <li>E : Бросить фигуру вниз</li>
            </ul>
            <p><strong>3. Очки:</strong> Очки начисляются за заполненные линии:</p>
            <ul>
                <li>1 линия: 100 очков</li>
                <li>2 линии: 300 очков</li>
                <li>3 линии: 500 очков</li>
                <li>4 линии: 800 очков</li>
            </ul>
            <p><strong>4. Уровни:</strong> Скорость падения фигур увеличивается каждые 10 заполненных линий.</p>
            <p><strong>5. Конец игры:</strong> Игра заканчивается для игрока, если новые фигуры не могут появиться на его поле.</p>
        </div>
    </div>

    <script>
        // Проверка загрузки Firebase
        if (typeof firebase === 'undefined') {
            console.error('Firebase не загружен. Проверьте подключение к интернету или URL скрипта.');
            showMessage('Ошибка загрузки Firebase. Проверьте подключение.', 'error');
            throw new Error('Firebase not loaded');
        }

        // Инициализация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA-qRTFlszcMafJv1eesYg-PUxsxYoo28U",
            authDomain: "misha-and-anna-48e4c.firebaseapp.com",
            databaseURL: "https://misha-and-anna-48e4c-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "misha-and-anna-48e4c",
            storageBucket: "misha-and-anna-48e4c.firebasestorage.app",
            messagingSenderId: "822036073579",
            appId: "1:822036073579:web:cd59fd4f5362b5f0bb752e",
            measurementId: "G-XR86X6PXMX"
        };
        
        let database = null;
        let isFirebaseInitialized = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            isFirebaseInitialized = true;
            console.log('Firebase инициализирован успешно');
        } catch (error) {
            console.error('Ошибка инициализации Firebase:', error);
            showMessage(`Ошибка подключения к Firebase: ${error.message}`, 'error');
        }
        
        // Глобальные переменные
        let localPlayer = {
            name: '',
            board: [],
            currentPiece: null,
            nextPiece: null,
            score: 0,
            lines: 0,
            level: 1,
            gameState: 'idle',
            gameLoop: null,
            isLocal: true
        };
        let remotePlayer = {
            name: '',
            board: [],
            currentPiece: null,
            nextPiece: null,
            score: 0,
            lines: 0,
            level: 1,
            gameState: 'idle',
            gameLoop: null,
            isLocal: false
        };
        let gameId = null;
        let playerId = null;
        const boardWidth = 10;
        const boardHeight = 20;
        
        // Определение фигур тетриса
        const pieces = [
            { shape: [[1, 1, 1, 1]], color: 'cyan' }, // I
            { shape: [[1, 1], [1, 1]], color: 'yellow' }, // O
            { shape: [[0, 1, 0], [1, 1, 1]], color: 'purple' }, // T
            { shape: [[0, 1, 1], [1, 1, 0]], color: 'green' }, // S
            { shape: [[1, 1, 0], [0, 1, 1]], color: 'red' }, // Z
            { shape: [[1, 0, 0], [1, 1, 1]], color: 'blue' }, // J
            { shape: [[0, 0, 1], [1, 1, 1]], color: 'orange' } // L
        ];
        
        // Элементы DOM
        const playerNameInput = document.getElementById('playerName');
        const gameIdInput = document.getElementById('gameId');
        const connectGameButton = document.getElementById('connectGame');
        const startGameButton = document.getElementById('startGame');
        const pauseButton = document.getElementById('pauseButton');
        const restartButton = document.getElementById('restartButton');
        const messageElement = document.getElementById('message');
        const gameInfoElement = document.getElementById('gameInfo');
        const gameBoard1Element = document.getElementById('gameBoard1');
        const gameBoard2Element = document.getElementById('gameBoard2');
        const previewBoard1Element = document.getElementById('previewBoard1');
        const previewBoard2Element = document.getElementById('previewBoard2');
        const score1Element = document.getElementById('score1');
        const level1Element = document.getElementById('level1');
        const lines1Element = document.getElementById('lines1');
        const score2Element = document.getElementById('score2');
        const level2Element = document.getElementById('level2');
        const lines2Element = document.getElementById('lines2');
        const player1TitleElement = document.getElementById('player1Title');
        const player2TitleElement = document.getElementById('player2Title');
        
        // Инициализация игрового поля
        function initializeBoard(player, boardElement) {
            try {
                player.board = Array(boardHeight).fill().map(() => Array(boardWidth).fill(0));
                boardElement.innerHTML = '';
                for (let row = 0; row < boardHeight; row++) {
                    for (let col = 0; col < boardWidth; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        boardElement.appendChild(cell);
                    }
                }
            } catch (error) {
                console.error('Ошибка инициализации поля:', error);
                showMessage(`Ошибка при создании игрового поля: ${error.message}`, 'error');
            }
        }
        
        // Инициализация поля предпросмотра
        function initializePreviewBoard(previewBoardElement) {
            try {
                previewBoardElement.innerHTML = '';
                for (let row = 0; row < 4; row++) {
                    for (let col = 0; col < 4; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        previewBoardElement.appendChild(cell);
                    }
                }
            } catch (error) {
                console.error('Ошибка инициализации поля предпросмотра:', error);
                showMessage(`Ошибка при создании поля предпросмотра: ${error.message}`, 'error');
            }
        }
        
        // Генерация новой фигуры
        function generatePiece() {
            try {
                const index = Math.floor(Math.random() * pieces.length);
                return {
                    shape: pieces[index].shape.map(row => [...row]),
                    color: pieces[index].color,
                    x: Math.floor(boardWidth / 2) - Math.floor(pieces[index].shape[0].length / 2),
                    y: 0
                };
            } catch (error) {
                console.error('Ошибка генерации фигуры:', error);
                showMessage(`Ошибка при создании новой фигуры: ${error.message}`, 'error');
                return null;
            }
        }
        
        // Отрисовка игрового поля
        function drawBoard(player, boardElement) {
            try {
                for (let row = 0; row < boardHeight; row++) {
                    for (let col = 0; col < boardWidth; col++) {
                        const cell = boardElement.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                        if (!cell) continue;
                        cell.classList.remove('filled', 'moving');
                        if (player.board[row][col]) {
                            cell.classList.add('filled');
                        }
                    }
                }
                
                if (player.currentPiece) {
                    player.currentPiece.shape.forEach((row, dy) => {
                        row.forEach((value, dx) => {
                            if (value) {
                                const x = player.currentPiece.x + dx;
                                const y = player.currentPiece.y + dy;
                                if (y >= 0 && y < boardHeight && x >= 0 && x < boardWidth) {
                                    const cell = boardElement.querySelector(`[data-row="${y}"][data-col="${x}"]`);
                                    if (cell) cell.classList.add('moving');
                                }
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Ошибка отрисовки поля:', error);
                showMessage(`Ошибка при отрисовке игрового поля: ${error.message}`, 'error');
            }
        }
        
        // Отрисовка следующей фигуры
        function drawPreview(player, previewBoardElement) {
            try {
                previewBoardElement.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('filled', 'moving');
                });
                
                if (player.nextPiece) {
                    player.nextPiece.shape.forEach((row, dy) => {
                        row.forEach((value, dx) => {
                            if (value) {
                                const cell = previewBoardElement.querySelector(`[data-row="${dy}"][data-col="${dx}"]`);
                                if (cell) {
                                    cell.classList.add('filled');
                                }
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Ошибка отрисовки предпросмотра:', error);
                showMessage(`Ошибка при отрисовке следующей фигуры: ${error.message}`, 'error');
            }
        }
        
        // Проверка столкновения
        function isCollision(piece, board) {
            try {
                return piece.shape.some((row, dy) => {
                    return row.some((value, dx) => {
                        if (value) {
                            const x = piece.x + dx;
                            const y = piece.y + dy;
                            return (
                                x < 0 ||
                                x >= boardWidth ||
                                y >= boardHeight ||
                                (y >= 0 && board[y][x])
                            );
                        }
                        return false;
                    });
                });
            } catch (error) {
                console.error('Ошибка проверки столкновения:', error);
                showMessage(`Ошибка при проверке столкновения фигур: ${error.message}`, 'error');
                return true;
            }
        }
        
        // Поворот фигуры
        function rotatePiece(player) {
            try {
                const newShape = Array(player.currentPiece.shape[0].length)
                    .fill()
                    .map((_, i) => Array(player.currentPiece.shape.length).fill(0));
                
                for (let y = 0; y < player.currentPiece.shape.length; y++) {
                    for (let x = 0; x < player.currentPiece.shape[y].length; x++) {
                        newShape[x][player.currentPiece.shape.length - 1 - y] = player.currentPiece.shape[y][x];
                    }
                }
                
                const originalShape = player.currentPiece.shape;
                player.currentPiece.shape = newShape;
                
                if (isCollision(player.currentPiece, player.board)) {
                    player.currentPiece.shape = originalShape;
                }
                if (player.isLocal) {
                    syncLocalPlayerState();
                }
            } catch (error) {
                console.error('Ошибка поворота фигуры:', error);
                showMessage(`Ошибка при повороте фигуры: ${error.message}`, 'error');
            }
        }
        
        // Фиксация фигуры на поле
        function mergePiece(player) {
            try {
                player.currentPiece.shape.forEach((row, dy) => {
                    row.forEach((value, dx) => {
                        if (value) {
                            const x = player.currentPiece.x + dx;
                            const y = player.currentPiece.y + dy;
                            if (y >= 0) {
                                player.board[y][x] = 1;
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Ошибка фиксации фигуры:', error);
                showMessage(`Ошибка при фиксации фигуры: ${error.message}`, 'error');
            }
        }
        
        // Удаление заполненных линий
        function clearLines(player) {
            try {
                let linesCleared = 0;
                player.board = player.board.filter((row, index) => {
                    if (row.every(cell => cell)) {
                        linesCleared++;
                        return false;
                    }
                    return true;
                });
                
                while (player.board.length < boardHeight) {
                    player.board.unshift(Array(boardWidth).fill(0));
                }
                
                if (linesCleared > 0) {
                    player.lines += linesCleared;
                    player.score += [0, 100, 300, 500, 800][linesCleared];
                    if (player.lines % 10 === 0) {
                        player.level++;
                    }
                    updateStats(player);
                }
            } catch (error) {
                console.error('Ошибка удаления линий:', error);
                showMessage(`Ошибка при удалении заполненных линий: ${error.message}`, 'error');
            }
        }
        
        // Обновление статистики
        function updateStats(player) {
            try {
                const prefix = player.isLocal ? '1' : '2';
                document.getElementById(`score${prefix}`).textContent = player.score;
                document.getElementById(`level${prefix}`).textContent = player.level;
                document.getElementById(`lines${prefix}`).textContent = player.lines;
                if (player.isLocal) {
                    syncLocalPlayerState();
                }
            } catch (error) {
                console.error('Ошибка обновления статистики:', error);
                showMessage(`Ошибка при обновлении статистики: ${error.message}`, 'error');
            }
        }
        
        // Основной игровой цикл
        function gameTick(player, boardElement, previewBoardElement) {
            try {
                if (player.gameState !== 'playing') return;
                
                player.currentPiece.y++;
                if (isCollision(player.currentPiece, player.board)) {
                    player.currentPiece.y--;
                    mergePiece(player);
                    clearLines(player);
                    player.currentPiece = player.nextPiece;
                    player.nextPiece = generatePiece();
                    
                    if (!player.currentPiece || isCollision(player.currentPiece, player.board)) {
                        endGame(player);
                        return;
                    }
                    
                    drawPreview(player, previewBoardElement);
                }
                
                drawBoard(player, boardElement);
                if (player.isLocal) {
                    syncLocalPlayerState();
                }
            } catch (error) {
                console.error('Ошибка игрового цикла:', error);
                showMessage(`Ошибка в игровом процессе: ${error.message}`, 'error');
            }
        }
        
        // Подключение к игре
        async function connectToGame() {
            try {
                if (!isFirebaseInitialized || !database) {
                    showMessage('Firebase не инициализирован. Проверьте настройки проекта.', 'error');
                    return;
                }
                
                const name = playerNameInput.value.trim();
                let inputGameId = gameIdInput.value.trim();
                
                if (!name) {
                    showMessage('Пожалуйста, введите ваше имя', 'error');
                    return;
                }
                
                if (!inputGameId) {
                    // Создать новую игру
                    inputGameId = Math.random().toString(36).substr(2, 9);
                    gameId = inputGameId;
                    playerId = 'player1';
                    localPlayer.name = name;
                    remotePlayer.name = '';
                    
                    await database.ref(`games/${gameId}`).set({
                        player1: {
                            name: name,
                            connected: true,
                            ready: false,
                            board: Array(boardHeight).fill().map(() => Array(boardWidth).fill(0)),
                            currentPiece: null,
                            nextPiece: null,
                            score: 0,
                            lines: 0,
                            level: 1,
                            gameState: 'idle'
                        },
                        player2: {
                            name: '',
                            connected: false,
                            ready: false,
                            board: Array(boardHeight).fill().map(() => Array(boardWidth).fill(0)),
                            currentPiece: null,
                            nextPiece: null,
                            score: 0,
                            lines: 0,
                            level: 1,
                            gameState: 'idle'
                        },
                        gameState: 'waiting'
                    }).catch(error => {
                        console.error('Ошибка создания игры:', error);
                        showMessage(`Не удалось создать игру: ${error.message}`, 'error');
                        throw error;
                    });
                    
                    showMessage(`Игра создана! ID игры: ${gameId}. Поделитесь этим ID с Аннютой.`, 'success');
                } else {
                    // Проверка существования игры
                    const snapshot = await database.ref(`games/${inputGameId}`).once('value');
                    if (!snapshot.exists()) {
                        showMessage(`Игра с ID ${inputGameId} не найдена`, 'error');
                        return;
                    }
                    const gameData = snapshot.val();
                    if (gameData.player2.connected) {
                        showMessage('Игра уже заполнена двумя игроками', 'error');
                        return;
                    }
                    
                    // Присоединиться к существующей игре
                    gameId = inputGameId;
                    playerId = 'player2';
                    localPlayer.name = name;
                    remotePlayer.name = gameData.player1.name || 'Игрок 1';
                    
                    await database.ref(`games/${gameId}/player2`).update({
                        name: name,
                        connected: true,
                        ready: false
                    }).catch(error => {
                        console.error('Ошибка подключения к игре:', error);
                        showMessage(`Не удалось подключиться к игре: ${error.message}`, 'error');
                        throw error;
                    });
                    
                    showMessage(`Вы подключились к игре с ID: ${gameId}`, 'success');
                }
                
                playerNameInput.disabled = true;
                gameIdInput.disabled = true;
                connectGameButton.disabled = true;
                startGameButton.disabled = false;
                
                // Слушать изменения в игре
                database.ref(`games/${gameId}`).on('value', (snapshot) => {
                    try {
                        const gameData = snapshot.val();
                        if (!gameData) {
                            console.warn('Данные игры отсутствуют');
                            showMessage('Игра не найдена. Попробуйте создать новую.', 'error');
                            return;
                        }
                        
                        // Обновить имена игроков
                        localPlayer.name = gameData[playerId]?.name || '';
                        remotePlayer.name = playerId === 'player1' ? (gameData.player2?.name || '') : (gameData.player1?.name || '');
                        
                        // Обновить статус подключения
                        if (gameData.player1?.connected && gameData.player2?.connected) {
                            player1TitleElement.innerHTML = `<i class="fas fa-gamepad"></i> Поле ${gameData.player1.name || 'Игрок 1'}`;
                            player2TitleElement.innerHTML = `<i class="fas fa-gamepad"></i> Поле ${gameData.player2.name || 'Игрок 2'}`;
                            gameInfoElement.innerHTML = '<i class="fas fa-info-circle"></i> Оба игрока подключены! Нажмите "Начать игру".';
                        }
                        
                        // Обновить состояние удаленного игрока
                        const remotePlayerKey = playerId === 'player1' ? 'player2' : 'player1';
                        remotePlayer.board = gameData[remotePlayerKey]?.board || Array(boardHeight).fill().map(() => Array(boardWidth).fill(0));
                        remotePlayer.currentPiece = gameData[remotePlayerKey]?.currentPiece || null;
                        remotePlayer.nextPiece = gameData[remotePlayerKey]?.nextPiece || null;
                        remotePlayer.score = gameData[remotePlayerKey]?.score || 0;
                        remotePlayer.lines = gameData[remotePlayerKey]?.lines || 0;
                        remotePlayer.level = gameData[remotePlayerKey]?.level || 1;
                        remotePlayer.gameState = gameData[remotePlayerKey]?.gameState || 'idle';
                        
                        drawBoard(remotePlayer, gameBoard2Element);
                        drawPreview(remotePlayer, previewBoard2Element);
                        updateStats(remotePlayer);
                        
                        // Проверка готовности к началу игры
                        if (gameData.player1?.ready && gameData.player2?.ready && gameData.gameState === 'starting') {
                            startGame();
                        }
                    } catch (error) {
                        console.error('Ошибка обработки данных Firebase:', error);
                        showMessage(`Ошибка синхронизации игры: ${error.message}`, 'error');
                    }
                }, (error) => {
                    console.error('Ошибка слушателя Firebase:', error);
                    showMessage(`Ошибка подключения к игре: ${error.message}`, 'error');
                });
            } catch (error) {
                console.error('Ошибка подключения к игре:', error);
                showMessage(`Ошибка при подключении к игре: ${error.message}`, 'error');
            }
        }
        
        // Синхронизация состояния локального игрока
        function syncLocalPlayerState() {
            try {
                if (!isFirebaseInitialized || !database) {
                    showMessage('Firebase не инициализирован. Синхронизация невозможна.', 'error');
                    return;
                }
                if (!gameId || !playerId) return;
                database.ref(`games/${gameId}/${playerId}`).update({
                    board: localPlayer.board,
                    currentPiece: localPlayer.currentPiece,
                    nextPiece: localPlayer.nextPiece,
                    score: localPlayer.score,
                    lines: localPlayer.lines,
                    level: localPlayer.level,
                    gameState: localPlayer.gameState
                }).catch(error => {
                    console.error('Ошибка синхронизации состояния:', error);
                    showMessage(`Ошибка синхронизации данных: ${error.message}`, 'error');
                });
            } catch (error) {
                console.error('Ошибка синхронизации:', error);
                showMessage(`Ошибка при синхронизации данных: ${error.message}`, 'error');
            }
        }
        
        // Начало игры
        async function startGame() {
            try {
                if (!isFirebaseInitialized || !database) {
                    showMessage('Firebase не инициализирован. Проверьте настройки проекта.', 'error');
                    return;
                }
                if (!gameId || !playerId) {
                    showMessage('Пожалуйста, подключитесь к игре', 'error');
                    return;
                }
                
                // Установить статус готовности
                await database.ref(`games/${gameId}/${playerId}`).update({
                    ready: true
                }).catch(error => {
                    console.error('Ошибка установки готовности:', error);
                    showMessage(`Ошибка при запуске игры: ${error.message}`, 'error');
                    throw error;
                });
                
                // Обновить состояние игры
                await database.ref(`games/${gameId}`).update({
                    gameState: 'starting'
                }).catch(error => {
                    console.error('Ошибка обновления состояния игры:', error);
                    showMessage(`Ошибка при запуске игры: ${error.message}`, 'error');
                    throw error;
                });
                
                localPlayer.gameState = 'playing';
                remotePlayer.gameState = 'playing';
                localPlayer.score = 0;
                localPlayer.lines = 0;
                localPlayer.level = 1;
                remotePlayer.score = 0;
                remotePlayer.lines = 0;
                remotePlayer.level = 1;
                
                initializeBoard(localPlayer, gameBoard1Element);
                initializeBoard(remotePlayer, gameBoard2Element);
                localPlayer.currentPiece = generatePiece();
                localPlayer.nextPiece = generatePiece();
                
                if (!localPlayer.currentPiece || !localPlayer.nextPiece) {
                    throw new Error('Не удалось создать фигуры');
                }
                
                drawBoard(localPlayer, gameBoard1Element);
                drawPreview(localPlayer, previewBoard1Element);
                updateStats(localPlayer);
                
                startGameButton.disabled = true;
                pauseButton.disabled = false;
                restartButton.disabled = false;
                
                gameInfoElement.innerHTML = '<i class="fas fa-gamepad"></i> Игра началась!';
                showMessage('Игра началась! Удачи!', 'success');
                
                clearInterval(localPlayer.gameLoop);
                localPlayer.gameLoop = setInterval(() => gameTick(localPlayer, gameBoard1Element, previewBoard1Element), 1000 / localPlayer.level);
                
                syncLocalPlayerState();
            } catch (error) {
                console.error('Ошибка запуска игры:', error);
                showMessage(`Ошибка при запуске игры: ${error.message}`, 'error');
            }
        }
        
        // Пауза игры
        function togglePause() {
            try {
                if (localPlayer.gameState === 'playing') {
                    localPlayer.gameState = 'paused';
                    clearInterval(localPlayer.gameLoop);
                    pauseButton.innerHTML = '<i class="fas fa-play"></i> Продолжить';
                    gameInfoElement.innerHTML = '<i class="fas fa-pause"></i> Игра на паузе';
                    showMessage('Игра на паузе', 'info');
                    syncLocalPlayerState();
                } else if (localPlayer.gameState === 'paused') {
                    localPlayer.gameState = 'playing';
                    localPlayer.gameLoop = setInterval(() => gameTick(localPlayer, gameBoard1Element, previewBoard1Element), 1000 / localPlayer.level);
                    pauseButton.innerHTML = '<i class="fas fa-pause"></i> Пауза';
                    gameInfoElement.innerHTML = '<i class="fas fa-gamepad"></i> Игра продолжается!';
                    showMessage('Игра продолжается!', 'success');
                    syncLocalPlayerState();
                }
            } catch (error) {
                console.error('Ошибка паузы игры:', error);
                showMessage(`Ошибка при паузе игры: ${error.message}`, 'error');
            }
        }
        
        // Конец игры
        function endGame(player) {
            try {
                player.gameState = 'ended';
                clearInterval(player.gameLoop);
                showMessage(`Игра окончена для ${player.name || 'игрока'}! Счет: ${player.score}`, 'error');
                
                if (player.isLocal) {
                    syncLocalPlayerState();
                    if (player.name && player.score > 0 && isFirebaseInitialized && database) {
                        database.ref('highscores').push({
                            name: player.name,
                            score: player.score,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        }).catch(error => {
                            console.error('Ошибка сохранения рекорда:', error);
                            showMessage(`Ошибка сохранения счета: ${error.message}`, 'error');
                        });
                    }
                }
                
                if (localPlayer.gameState === 'ended' && remotePlayer.gameState === 'ended') {
                    gameInfoElement.innerHTML = '<i class="fas fa-skull-crossbones"></i> Игра окончена для обоих игроков!';
                    pauseButton.disabled = true;
                }
            } catch (error) {
                console.error('Ошибка завершения игры:', error);
                showMessage(`Ошибка при завершении игры: ${error.message}`, 'error');
            }
        }
        
        // Перезапуск игры
        function restartGame() {
            try {
                if (!isFirebaseInitialized || !database) {
                    showMessage('Firebase не инициализирован. Перезапуск невозможен.', 'error');
                    return;
                }
                if (!gameId || !playerId) return;
                
                localPlayer.gameState = 'idle';
                remotePlayer.gameState = 'idle';
                clearInterval(localPlayer.gameLoop);
                
                initializeBoard(localPlayer, gameBoard1Element);
                initializeBoard(remotePlayer, gameBoard2Element);
                localPlayer.score = 0;
                localPlayer.lines = 0;
                localPlayer.level = 1;
                remotePlayer.score = 0;
                remotePlayer.lines = 0;
                remotePlayer.level = 1;
                updateStats(localPlayer);
                updateStats(remotePlayer);
                
                database.ref(`games/${gameId}`).set({
                    player1: {
                        name: localPlayer.name,
                        connected: true,
                        ready: false,
                        board: Array(boardHeight).fill().map(() => Array(boardWidth).fill(0)),
                        currentPiece: null,
                        nextPiece: null,
                        score: 0,
                        lines: 0,
                        level: 1,
                        gameState: 'idle'
                    },
                    player2: {
                        name: remotePlayer.name,
                        connected: true,
                        ready: false,
                        board: Array(boardHeight).fill().map(() => Array(boardWidth).fill(0)),
                        currentPiece: null,
                        nextPiece: null,
                        score: 0,
                        lines: 0,
                        level: 1,
                        gameState: 'idle'
                    },
                    gameState: 'waiting'
                }).catch(error => {
                    console.error('Ошибка перезапуска игры:', error);
                    showMessage(`Ошибка при перезапуске игры: ${error.message}`, 'error');
                });
                
                gameInfoElement.innerHTML = '<i class="fas fa-info-circle"></i> Нажмите "Начать игру"';
                showMessage('Игра перезапущена', 'info');
                
                playerNameInput.disabled = true;
                gameIdInput.disabled = true;
                connectGameButton.disabled = true;
                startGameButton.disabled = false;
                pauseButton.disabled = true;
                restartButton.disabled = true;
            } catch (error) {
                console.error('Ошибка перезапуска игры:', error);
                showMessage(`Ошибка при перезапуске игры: ${error.message}`, 'error');
            }
        }
        
        // Обработка клавиш для локального игрока
        function handleKeyPress(event) {
            try {
                if (localPlayer.gameState !== 'playing') return;
                
                // Prevent default scrolling behavior for movement keys
                if (['ArrowLeft', 'ArrowRight', 'ArrowDown', 'ArrowUp', ' '].includes(event.key)) {
                    event.preventDefault();
                }
                
                switch (event.key) {
                    case 'ArrowLeft':
                        localPlayer.currentPiece.x--;
                        if (isCollision(localPlayer.currentPiece, localPlayer.board)) {
                            localPlayer.currentPiece.x++;
                        }
                        break;
                    case 'ArrowRight':
                        localPlayer.currentPiece.x++;
                        if (isCollision(localPlayer.currentPiece, localPlayer.board)) {
                            localPlayer.currentPiece.x--;
                        }
                        break;
                    case 'ArrowDown':
                        localPlayer.currentPiece.y++;
                        if (isCollision(localPlayer.currentPiece, localPlayer.board)) {
                            localPlayer.currentPiece.y--;
                        }
                        break;
                    case 'ArrowUp':
                        rotatePiece(localPlayer);
                        break;
                    case ' ':
                        while (!isCollision(localPlayer.currentPiece, localPlayer.board)) {
                            localPlayer.currentPiece.y++;
                        }
                        localPlayer.currentPiece.y--;
                        mergePiece(localPlayer);
                        clearLines(localPlayer);
                        localPlayer.currentPiece = localPlayer.nextPiece;
                        localPlayer.nextPiece = generatePiece();
                        if (!localPlayer.currentPiece || isCollision(localPlayer.currentPiece, localPlayer.board)) {
                            endGame(localPlayer);
                            return;
                        }
                        drawPreview(localPlayer, previewBoard1Element);
                        break;
                }
                drawBoard(localPlayer, gameBoard1Element);
                syncLocalPlayerState();
            } catch (error) {
                console.error('Ошибка обработки клавиш:', error);
                showMessage(`Ошибка управления игрой: ${error.message}`, 'error');
            }
        }
        
        // Отображение сообщения
        function showMessage(text, type = 'info') {
            try {
                messageElement.textContent = text;
                messageElement.className = `message ${type} visible`;
                
                setTimeout(() => {
                    messageElement.classList.remove('visible');
                }, 5000);
            } catch (error) {
                console.error('Ошибка отображения сообщения:', error);
            }
        }
        
        // Обработчики событий
        try {
            connectGameButton.addEventListener('click', connectToGame);
            startGameButton.addEventListener('click', startGame);
            pauseButton.addEventListener('click', togglePause);
            restartButton.addEventListener('click', restartGame);
            document.addEventListener('keydown', handleKeyPress);
        } catch (error) {
            console.error('Ошибка настройки обработчиков событий:', error);
            showMessage(`Ошибка инициализации интерфейса: ${error.message}`, 'error');
        }
        
        // Инициализация
        try {
            initializeBoard(localPlayer, gameBoard1Element);
            initializeBoard(remotePlayer, gameBoard2Element);
            initializePreviewBoard(previewBoard1Element);
            initializePreviewBoard(previewBoard2Element);
            gameInfoElement.innerHTML = '<i class="fas fa-info-circle"></i> Введите имя и ID игры, затем подключитесь!';
            console.log('Игра инициализирована');
        } catch (error) {
            console.error('Ошибка инициализации игры:', error);
            showMessage(`Ошибка при запуске игры: ${error.message}`, 'error');
        }
    </script>
</body>
</html>
